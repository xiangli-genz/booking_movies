extends ../layouts/default.pug

block main
  // Booking Combo Page
  .booking-combo-container
    .container
      // Progress Steps
      .booking-steps
        .step.completed
          .step-number 1
          .step-label Chọn ghế
        .step-arrow →
        .step.active
          .step-number 2
          .step-label Chọn combo
        .step-arrow →
        .step.pending
          .step-number 3
          .step-label Thanh toán
      
      .booking-combo-layout
        // Left: Combo Selection
        .combo-section
          h2.section-title
            i.fa-solid.fa-popcorn(style="margin-right: 10px;")
            | Chọn Combo
          
          .combo-list
            // Combo 1
            .combo-card
              .combo-image
                img(src="https://via.placeholder.com/120x120?text=Combo+1" alt="Combo 1")
              .combo-info
                .combo-name Beta Combo 69oz
                .combo-desc TIẾT KIỆM 28k!!! Gồm 1 Bắp (69oz) + 1 Nước có gaz (22oz)
                .combo-price-row
                  .combo-price
                    span.price-old 73.000đ
                    span.price-new 45.000đ
                  .combo-controls
                    button.btn-minus(data-combo="combo1") −
                    input.combo-quantity(type="text" value="0" readonly data-combo="combo1")
                    button.btn-plus(data-combo="combo1") +
            
            // Combo 2
            .combo-card
              .combo-image
                img(src="https://via.placeholder.com/120x120?text=Combo+2" alt="Combo 2")
              .combo-info
                .combo-name Sweet Combo 60oz
                .combo-desc TIẾT KIỆM 46k!!! Gồm 1 Bắp (60oz) + 2 Nước có gaz (22oz)
                .combo-price-row
                  .combo-price
                    span.price-old 96.000đ
                    span.price-new 50.000đ
                  .combo-controls
                    button.btn-minus(data-combo="combo2") −
                    input.combo-quantity(type="text" value="0" readonly data-combo="combo2")
                    button.btn-plus(data-combo="combo2") +
            
            // Combo 3
            .combo-card
              .combo-image
                img(src="https://via.placeholder.com/120x120?text=Combo+3" alt="Combo 3")
              .combo-info
                .combo-name Combo See Me - Lộc xuân
                .combo-desc Sét hủ ngày nắng: 1 Ly xoáy kèm nước cà phê sữa đá
                .combo-price-row
                  .combo-price
                    span.price-old 103.000đ
                    span.price-new 103.000đ
                  .combo-controls
                    button.btn-minus(data-combo="combo3") −
                    input.combo-quantity(type="text" value="0" readonly data-combo="combo3")
                    button.btn-plus(data-combo="combo3") +
            
            // Combo 4
            .combo-card
              .combo-image
                img(src="https://via.placeholder.com/120x120?text=Combo+4" alt="Combo 4")
              .combo-info
                .combo-name Family Combo 69oz
                .combo-desc TIẾT KIỆM 95k!!! Gồm 2 Bắp (69oz) + 4 Nước có gaz (22oz) + 2 Snack Oishi (80g)
                .combo-price-row
                  .combo-price
                    span.price-old 190.000đ
                    span.price-new 95.000đ
                  .combo-controls
                    button.btn-minus(data-combo="combo4") −
                    input.combo-quantity(type="text" value="0" readonly data-combo="combo4")
                    button.btn-plus(data-combo="combo4") +
            
            // Combo 5
            .combo-card
              .combo-image
                img(src="https://via.placeholder.com/120x120?text=Combo+5" alt="Combo 5")
              .combo-info
                .combo-name Combo See Me - Xương Rồng
                .combo-desc Lộc phát tài: 1 Ly xoáy kèm nước sữa dưỡng nhan
                .combo-price-row
                  .combo-price
                    span.price-old 120.000đ
                    span.price-new 120.000đ
                  .combo-controls
                    button.btn-minus(data-combo="combo5") −
                    input.combo-quantity(type="text" value="0" readonly data-combo="combo5")
                    button.btn-plus(data-combo="combo5") +
        
        // Right: Booking Summary
        .summary-section
          .movie-info-card
            .movie-poster
              img(src=movieDetail.avatar alt=movieDetail.name)
            
            .movie-details
              h3.movie-title #{movieDetail.name}
              .movie-subtitle #{movieDetail.ageRating || '2D'} Phụ đề
              
              .detail-row
                .detail-icon
                  i.fa-solid.fa-building
                .detail-content
                  .detail-label Rạp chiếu
                  .detail-value(id="cinema-display") Beta Thanh Xuân
              
              .detail-row
                .detail-icon
                  i.fa-regular.fa-calendar
                .detail-content
                  .detail-label Ngày chiếu
                  .detail-value(id="date-display") 07/12/2025
              
              .detail-row
                .detail-icon
                  i.fa-regular.fa-clock
                .detail-content
                  .detail-label Giờ chiếu
                  .detail-value(id="time-display") 20:15
              
              .detail-row
                .detail-icon
                  i.fa-solid.fa-couch
                .detail-content
                  .detail-label Ghế ngồi
                  .detail-value(id="seats-display") A1, A2, A3
          
          .price-summary
            h4.summary-title Chi Tiết Giá
            
            .price-row
              span Tiền vé
              span(id="ticket-price") 150.000đ
            
            .price-row
              span Tiền combo
              span(id="combo-price") 0đ
            
            .price-row.total-row
              strong Tổng cộng
              strong.total-amount(id="total-price") 150.000đ
          
          .action-buttons
            button.btn-back(onclick="history.back()") Quay lại
            button.btn-continue(id="btn-continue" data-movie-id=movieDetail.id) Tiếp tục

  style.
    .booking-combo-container {
      background: #f5f5f5;
      padding: 30px 0 60px;
      min-height: 100vh;
    }
    
    /* Progress Steps */
    .booking-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    
    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      background: #e0e0e0;
      color: #666;
    }
    
    .step.completed .step-number {
      background: #4CAF50;
      color: white;
    }
    
    .step.active .step-number {
      background: #2196F3;
      color: white;
    }
    
    .step-label {
      font-size: 14px;
      color: #666;
    }
    
    .step.active .step-label {
      color: #2196F3;
      font-weight: 600;
    }
    
    .step-arrow {
      margin: 0 20px;
      color: #bdbdbd;
      font-size: 24px;
    }
    
    /* Layout */
    .booking-combo-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 20px;
    }
    
    /* Combo Section */
    .combo-section {
      background: white;
      border-radius: 8px;
      padding: 30px;
    }
    
    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 0 0 25px 0;
      display: flex;
      align-items: center;
    }
    
    .combo-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .combo-card {
      display: flex;
      gap: 20px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: all 0.3s;
    }
    
    .combo-card:hover {
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
    }
    
    .combo-image {
      width: 120px;
      height: 120px;
      flex-shrink: 0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .combo-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .combo-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .combo-name {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }
    
    .combo-desc {
      font-size: 14px;
      color: #666;
      line-height: 1.5;
      margin-bottom: 15px;
      flex: 1;
    }
    
    .combo-price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .combo-price {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .price-old {
      font-size: 14px;
      color: #999;
      text-decoration: line-through;
    }
    
    .price-new {
      font-size: 20px;
      font-weight: 700;
      color: #EF5350;
    }
    
    .combo-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-minus,
    .btn-plus {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #2196F3;
      background: white;
      color: #2196F3;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .btn-minus:hover,
    .btn-plus:hover {
      background: #2196F3;
      color: white;
    }
    
    .combo-quantity {
      width: 50px;
      text-align: center;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 6px;
      font-size: 16px;
      font-weight: 600;
    }
    
    /* Summary Section */
    .summary-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }
    
    .movie-info-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }
    
    .movie-poster {
      width: 100%;
      margin-bottom: 20px;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .movie-poster img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .movie-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #2196F3;
    }
    
    .movie-subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .detail-icon {
      width: 24px;
      color: #2196F3;
      margin-top: 2px;
    }
    
    .detail-content {
      flex: 1;
    }
    
    .detail-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 2px;
    }
    
    .detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .price-summary {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }
    
    .summary-title {
      font-size: 18px;
      font-weight: 700;
      margin: 0 0 20px 0;
      color: #333;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 14px;
      color: #666;
    }
    
    .price-row.total-row {
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
      font-size: 18px;
      color: #333;
      margin-bottom: 0;
    }
    
    .total-amount {
      color: #EF5350;
      font-size: 24px;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .btn-back,
    .btn-continue {
      height: 50px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-back {
      background: #e0e0e0;
      color: #666;
    }
    
    .btn-back:hover {
      background: #d5d5d5;
    }
    
    .btn-continue {
      background: #2196F3;
      color: white;
    }
    
    .btn-continue:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    /* Responsive */
    @media (max-width: 991.98px) {
      .booking-combo-layout {
        grid-template-columns: 1fr;
      }
      
      .summary-section {
        position: static;
      }
      
      .booking-steps {
        overflow-x: auto;
      }
    }
    
    @media (max-width: 575.98px) {
      .combo-card {
        flex-direction: column;
      }
      
      .combo-image {
        width: 100%;
        height: 200px;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }

  script.
    document.addEventListener('DOMContentLoaded', function() {
      // Combo data với giá
      const combos = {
        combo1: { name: 'Beta Combo 69oz', price: 45000 },
        combo2: { name: 'Sweet Combo 60oz', price: 50000 },
        combo3: { name: 'Combo See Me - Lộc xuân', price: 103000 },
        combo4: { name: 'Family Combo 69oz', price: 95000 },
        combo5: { name: 'Combo See Me - Xương Rồng', price: 120000 }
      };
      
      // Lấy dữ liệu từ giỏ hàng
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      const movieId = document.getElementById('btn-continue').getAttribute('data-movie-id');
      
      // Tìm booking hiện tại
      let currentBooking = cart.find(item => item.tourId === movieId);
      
      if (!currentBooking) {
        alert('Không tìm thấy thông tin đặt vé. Vui lòng chọn ghế lại.');
        window.location.href = '/movie/detail/' + movieId;
        return;
      }
      
      // Hiển thị thông tin booking
      document.getElementById('cinema-display').textContent = currentBooking.locationFrom || 'Beta Thanh Xuân';
      document.getElementById('seats-display').textContent = currentBooking.seats ? currentBooking.seats.join(', ') : '-';
      
      // Tính tiền vé (giả sử có sẵn từ session trước)
      let ticketPrice = 0;
      if (currentBooking.seats && currentBooking.seats.length > 0) {
        // Tính toán dựa trên loại ghế (standard: 50k, vip: 60k, couple: 110k)
        currentBooking.seats.forEach(seat => {
          if (seat.includes('V')) ticketPrice += 60000;
          else if (seat.includes('C')) ticketPrice += 110000;
          else ticketPrice += 50000;
        });
      }
      
      document.getElementById('ticket-price').textContent = ticketPrice.toLocaleString('vi-VN') + 'đ';
      
      // Khởi tạo combo từ giỏ hàng nếu có
      if (currentBooking.combos) {
        Object.keys(currentBooking.combos).forEach(comboKey => {
          const qty = currentBooking.combos[comboKey]?.quantity || 0;
          if (qty > 0) {
            const input = document.querySelector(`[data-combo="${comboKey}"]`);
            if (input && input.classList.contains('combo-quantity')) {
              input.value = qty;
            }
          }
        });
      }
      
      // Xử lý tăng/giảm combo
      document.querySelectorAll('.btn-plus').forEach(btn => {
        btn.addEventListener('click', function() {
          const comboKey = this.getAttribute('data-combo');
          const input = document.querySelector(`.combo-quantity[data-combo="${comboKey}"]`);
          let qty = parseInt(input.value) || 0;
          qty++;
          input.value = qty;
          updateComboPrice();
        });
      });
      
      document.querySelectorAll('.btn-minus').forEach(btn => {
        btn.addEventListener('click', function() {
          const comboKey = this.getAttribute('data-combo');
          const input = document.querySelector(`.combo-quantity[data-combo="${comboKey}"]`);
          let qty = parseInt(input.value) || 0;
          if (qty > 0) {
            qty--;
            input.value = qty;
            updateComboPrice();
          }
        });
      });
      
      // Cập nhật giá combo
      function updateComboPrice() {
        let comboTotal = 0;
        
        Object.keys(combos).forEach(comboKey => {
          const input = document.querySelector(`.combo-quantity[data-combo="${comboKey}"]`);
          const qty = parseInt(input.value) || 0;
          if (qty > 0) {
            comboTotal += combos[comboKey].price * qty;
          }
        });
        
        document.getElementById('combo-price').textContent = comboTotal.toLocaleString('vi-VN') + 'đ';
        
        const total = ticketPrice + comboTotal;
        document.getElementById('total-price').textContent = total.toLocaleString('vi-VN') + 'đ';
      }
      
      // Khởi tạo giá ban đầu
      updateComboPrice();
      
      // Xử lý nút Tiếp tục
      document.getElementById('btn-continue').addEventListener('click', function() {
        // Thu thập dữ liệu combo
        const selectedCombos = {};
        
        Object.keys(combos).forEach(comboKey => {
          const input = document.querySelector(`.combo-quantity[data-combo="${comboKey}"]`);
          const qty = parseInt(input.value) || 0;
          if (qty > 0) {
            selectedCombos[comboKey] = {
              name: combos[comboKey].name,
              price: combos[comboKey].price,
              quantity: qty
            };
          }
        });
        
        // Cập nhật giỏ hàng
        const cartIndex = cart.findIndex(item => item.tourId === movieId);
        if (cartIndex !== -1) {
          cart[cartIndex].combos = selectedCombos;
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Chuyển sang trang giỏ hàng
        window.location.href = '/cart';
      });
    });