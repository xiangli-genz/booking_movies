extends ../layouts/default.pug
include ../mixins/box-breadcrumb.pug

block main
  +box-breadcrumb(breadcrumb)
  
  // Main booking layout
  .booking-container
    .container
      .booking-layout
        // Left: Seat Map
        .seat-section
          // Legend
          .seat-legend-top
            .legend-item
              .legend-icon.seat-empty Ghế trống
            .legend-item
              .legend-icon.seat-selecting Ghế đang chọn
            .legend-item
              .legend-icon.seat-selected Ghế đang được giữ
            .legend-item
              .legend-icon.seat-sold Ghế đã bán
            .legend-item
              .legend-icon.seat-booked Ghế đặt trước
          
          // Screen
          .screen-wrapper
            .screen-label MÀN HÌNH CHIẾU
          
          // Seat Grid
          .seat-grid-container
            - const rows = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L']
            - const seatsPerRow = 15
            - const vipRows = ['H', 'I', 'J', 'K']
            - const coupleRows = ['L']
            
            each row in rows
              .seat-row
                each val, colIndex in Array(seatsPerRow)
                  - const seatNumber = row + (colIndex + 1)
                  - let seatClass = 'seat-normal'
                  - if (vipRows.includes(row)) seatClass = 'seat-vip'
                  - if (coupleRows.includes(row)) seatClass = 'seat-couple'
                  
                  if coupleRows.includes(row) && colIndex % 2 === 0
                    - const coupleNum = row + (colIndex + 1) + '-' + row + (colIndex + 2)
                    .seat(
                      class=seatClass
                      data-seat=coupleNum
                      data-type='couple'
                      data-price=(movieDetail.prices ? movieDetail.prices.couple : 110000)
                      style="min-width: 70px;"
                    ) #{coupleNum}
                  else if !coupleRows.includes(row)
                    .seat(
                      class=seatClass
                      data-seat=seatNumber
                      data-type=(vipRows.includes(row) ? 'vip' : 'standard')
                      data-price=(vipRows.includes(row) ? (movieDetail.prices ? movieDetail.prices.vip : 60000) : (movieDetail.prices ? movieDetail.prices.standard : 50000))
                    ) #{seatNumber}
          
          // Bottom Legend
          .seat-legend-bottom
            .legend-row
              .legend-item-bottom
                .seat.seat-normal Ghế thường
              .legend-item-bottom
                .seat.seat-vip Ghế VIP
              .legend-item-bottom
                .seat.seat-couple(style="min-width: 70px;") Ghế đôi
              .total-section
                .total-label Tổng tiền
                .total-amount 0 vnđ
              .timer-section
                .timer-label Thời gian còn lại
                .timer-countdown 6:05
        
        // Right: Movie Info
        .info-section
          .movie-poster
            img(src=movieDetail.avatar alt=movieDetail.name)
          
          .movie-details
            h2.movie-title #{movieDetail.name}
            .movie-subtitle #{movieDetail.ageRating || '2D'} Phụ đề
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-tags
              .detail-label Thể loại
              .detail-value Hoạt hình
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-clock
              .detail-label Thời lượng
              .detail-value #{movieDetail.duration || '107 phút'}
            
            hr.divider
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-building
              .detail-label Rạp chiếu
              .detail-value(location-display) Beta Thanh Xuân
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-calendar
              .detail-label Ngày chiếu
              .detail-value(date-display) 07/12/2025
            
            .detail-row
              .detail-icon
                i.fa-regular.fa-clock
              .detail-label Giờ chiếu
              .detail-value(time-display) 20:15
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-door-open
              .detail-label Phòng chiếu
              .detail-value P2
            
            .detail-row
              .detail-icon
                i.fa-solid.fa-couch
              .detail-label Ghế ngồi
              .detail-value(seats-display) -
            
            .continue-btn
              button#btn-continue(tour-id=movieDetail.id) TIẾP TỤC

  // Hidden inputs for booking data
  input(type="hidden" name="cinema" location-from)
  input(type="hidden" name="showtimeDate")
  input(type="hidden" name="showtimeTime")
  input(type="hidden" name="showtimeFormat")

  style.
    .booking-container {
      background: #f5f5f5;
      padding: 20px 0 60px;
    }
    
    .booking-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 20px;
    }
    
    /* Seat Section */
    .seat-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
    }
    
    .seat-legend-top {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .legend-icon {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    
    .legend-icon.seat-empty {
      background: #e0e0e0;
      border: 2px solid #bdbdbd;
    }
    
    .legend-icon.seat-selecting {
      background: #2196F3;
      border: 2px solid #1976D2;
      color: white;
    }
    
    .legend-icon.seat-selected {
      background: #64B5F6;
      border: 2px solid #42A5F5;
    }
    
    .legend-icon.seat-sold {
      background: #EF5350;
      border: 2px solid #E53935;
      color: white;
    }
    
    .legend-icon.seat-booked {
      background: #FFA726;
      border: 2px solid #FB8C00;
      color: white;
    }
    
    .screen-wrapper {
      margin: 30px 0;
      position: relative;
    }
    
    .screen-wrapper::before {
      content: '';
      display: block;
      width: 100%;
      height: 4px;
      background: linear-gradient(to bottom, #999, #333);
      border-radius: 0 0 50% 50%;
      margin-bottom: 15px;
    }
    
    .screen-label {
      text-align: center;
      color: #999;
      font-size: 14px;
      letter-spacing: 2px;
      margin-bottom: 30px;
    }
    
    .seat-grid-container {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .seat-row {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .seat {
      min-width: 36px;
      height: 36px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid;
    }
    
    .seat-normal {
      background: #e0e0e0;
      border-color: #bdbdbd;
      color: #666;
    }
    
    .seat-vip {
      background: #EF5350;
      border-color: #E53935;
      color: white;
    }
    
    .seat-couple {
      background: #EF5350;
      border-color: #E53935;
      color: white;
    }
    
    .seat:hover:not(.seat-booked):not(.seat-disabled) {
      transform: scale(1.1);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    
    .seat.selected {
      background: #2196F3 !important;
      border-color: #1976D2 !important;
      color: white !important;
    }
    
    .seat.seat-booked {
      background: #757575 !important;
      border-color: #616161 !important;
      color: #999 !important;
      cursor: not-allowed !important;
    }
    
    .seat-legend-bottom {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .legend-row {
      display: flex;
      gap: 20px;
      align-items: center;
      flex: 1;
      flex-wrap: wrap;
    }
    
    .legend-item-bottom {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-item-bottom .seat {
      cursor: default;
    }
    
    .total-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 15px;
      border-left: 2px solid #ddd;
    }
    
    .total-label {
      font-size: 14px;
      color: #666;
    }
    
    .total-amount {
      font-size: 18px;
      font-weight: 700;
      color: #333;
    }
    
    .timer-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 15px;
      border-left: 2px solid #ddd;
    }
    
    .timer-label {
      font-size: 14px;
      color: #666;
    }
    
    .timer-countdown {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
    
    /* Info Section */
    .info-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .movie-poster {
      width: 100%;
      margin-bottom: 20px;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .movie-poster img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    .movie-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 8px 0;
      color: #2196F3;
    }
    
    .movie-subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 20px;
    }
    
    .detail-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .detail-icon {
      width: 24px;
      color: #2196F3;
    }
    
    .detail-label {
      color: #666;
      min-width: 90px;
    }
    
    .detail-value {
      font-weight: 600;
      color: #333;
    }
    
    .divider {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #e0e0e0;
    }
    
    .continue-btn {
      margin-top: 30px;
    }
    
    .continue-btn button {
      width: 100%;
      height: 50px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .continue-btn button:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
    }
    
    @media (max-width: 991.98px) {
      .booking-layout {
        grid-template-columns: 1fr;
      }
      
      .info-section {
        position: static;
      }
    }

  script.
    document.addEventListener('DOMContentLoaded', function() {
      const movieId = '#{movieDetail.id}';
      let selectedSeats = [];
      let bookedSeats = [];
      let countdownTimer;
      let timeRemaining = 365; // 6:05 = 365 seconds
      
      // Get booking data from URL or default
      const urlParams = new URLSearchParams(window.location.search);
      const cinema = urlParams.get('cinema') || 'Beta Thanh Xuân';
      const date = urlParams.get('date') || '2025-12-07';
      const time = urlParams.get('time') || '20:15';
      const format = urlParams.get('format') || '2D';
      
      // Set hidden inputs
      document.querySelector('[location-from]').value = cinema;
      document.querySelector('[name="showtimeDate"]').value = date;
      document.querySelector('[name="showtimeTime"]').value = time;
      document.querySelector('[name="showtimeFormat"]').value = format;
      
      // Update display values
      document.querySelector('[location-display]').textContent = cinema;
      document.querySelector('[date-display]').textContent = new Date(date).toLocaleDateString('vi-VN');
      document.querySelector('[time-display]').textContent = time;
      
      // Load booked seats
      loadBookedSeats();
      
      // Start countdown
      startCountdown();
      
      async function loadBookedSeats() {
        try {
          const response = await fetch(`/booking/booked-seats?movieId=${movieId}&cinema=${encodeURIComponent(cinema)}&date=${date}&time=${encodeURIComponent(time)}`);
          const data = await response.json();
          if (data.code === 'success') {
            bookedSeats = data.bookedSeats || [];
            updateSeatDisplay();
          }
        } catch (error) {
          console.error('Error loading booked seats:', error);
        }
      }
      
      function startCountdown() {
        updateCountdownDisplay();
        countdownTimer = setInterval(() => {
          timeRemaining--;
          if (timeRemaining <= 0) {
            clearInterval(countdownTimer);
            alert('Hết thời gian giữ ghế!');
            window.location.reload();
          }
          updateCountdownDisplay();
        }, 1000);
      }
      
      function updateCountdownDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.querySelector('.timer-countdown').textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
      
      // Seat selection
      document.querySelectorAll('.seat:not(.seat-disabled)').forEach(seat => {
        seat.addEventListener('click', function() {
          if (this.classList.contains('seat-booked')) return;
          
          const seatNumber = this.getAttribute('data-seat');
          const index = selectedSeats.indexOf(seatNumber);
          
          if (index > -1) {
            selectedSeats.splice(index, 1);
            this.classList.remove('selected');
          } else {
            selectedSeats.push(seatNumber);
            this.classList.add('selected');
          }
          
          updateTotalPrice();
          updateSeatsDisplay();
        });
      });
      
      function updateSeatDisplay() {
        document.querySelectorAll('.seat').forEach(seat => {
          const seatNumber = seat.getAttribute('data-seat');
          if (bookedSeats.includes(seatNumber)) {
            seat.classList.add('seat-booked');
          }
        });
      }
      
      function updateTotalPrice() {
        let total = 0;
        selectedSeats.forEach(seatNumber => {
          const seatEl = document.querySelector(`[data-seat="${seatNumber}"]`);
          if (seatEl) {
            total += parseInt(seatEl.getAttribute('data-price')) || 0;
          }
        });
        
        document.querySelector('.total-amount').textContent = 
          total.toLocaleString('vi-VN') + ' vnđ';
      }
      
      function updateSeatsDisplay() {
        const display = document.querySelector('[seats-display]');
        display.textContent = selectedSeats.length > 0 ? selectedSeats.join(', ') : '-';
      }
      
      // Continue button
      document.getElementById('btn-continue').addEventListener('click', function() {
        if (selectedSeats.length === 0) {
          alert('Vui lòng chọn ít nhất 1 ghế!');
          return;
        }
        
        const tourId = this.getAttribute('tour-id');
        const locationFrom = document.querySelector('[location-from]').value;
        
        const cartItem = {
          tourId,
          locationFrom,
          seats: selectedSeats,
          combos: {},
          checked: true
        };
        
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const existingIndex = cart.findIndex(item => 
          item.tourId === tourId && item.locationFrom === locationFrom
        );
        
        if (existingIndex !== -1) {
          cart[existingIndex] = cartItem;
        } else {
          cart.push(cartItem);
        }
        
        localStorage.setItem('cart', JSON.stringify(cart));
        
        // Redirect to combo selection page or cart
        window.location.href = '/cart';
      });
    });